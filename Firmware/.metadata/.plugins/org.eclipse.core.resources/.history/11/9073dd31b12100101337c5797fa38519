/*
 * reflow_oven_process.h
 *
 *  Created on: Apr 22, 2025
 *      Author: adrian
 */

#ifndef INC_REFLOW_OVEN_PROCESS_H_
#define INC_REFLOW_OVEN_PROCESS_H_

/******************************************************************************
 * INCLUDES
 *****************************************************************************/
#include <stdint.h>
#include <stdbool.h>
#include "pid.h"

/******************************************************************************
 * EXTERNAL REFERENCES
 *****************************************************************************/
/* PID's data type instance */
extern PIDController PID;

typedef enum
{
    REFLOW_PREHEAT,  /* Preheat phase: Initial phase where the oven starts heating up to reach the soak temperature */
    REFLOW_SOAK,     /* Soak phase: Maintain a steady temperature to ensure uniform heating */
    REFLOW_HEATUP,   /* Second heat up phase: Rapidly increase temperature to reach reflow point */
    REFLOW_REFLOW,   /* Reflow phase: Peak temperature to melt solder and form joints */
    REFLOW_COOLDOWN, /* Cool down phase: Gradual cooling to solidify solder joints */
    REFLOW_IDLE,     /* Idle phase: Oven is not actively running a process */
} ReflowPhases_t;

typedef enum
{
    PARAM_Pre_HeatUpRate,    /* Preheat rise time (°C/s) */
    PARAM_SoakTempeture,     /* Soak temperature (°C) */
    PARAM_SoakTime,          /* Soak duration (seconds) */
    PARAM_HeatUpRate,        /* Second heat up rate (°C/s) */
    PARAM_ReflowTempeture,   /* Reflow temperature (°C) */
    PARAM_ReflowTime,        /* Reflow duration (seconds) */
    PARAM_CoolDownRate,      /* Cool down rate (°C/s) */
    PARAM_CoolDownTempeture, /* Cool down temperature (°C) */
} ReflowParameters_enum;

typedef struct
{
    float Pre_HeatUpRate;    /* Preheat rise time (°C/s) */
    float SoakTempeture;     /* Soak temperature (°C) */
    float SoakTime;          /* Soak duration (seconds) */
    float HeatUpRate;        /* Second heat up rate (°C/s) */
    float ReflowTempeture;   /* Reflow temperature (°C) */
    float ReflowTime;        /* Reflow duration (seconds) */
    float CoolDownRate;      /* Cool down rate (°C/s) */
    float CoolDownTempeture; /* Cool down temperature (°C) */
} ReflowOven_parameters_t;

typedef struct
{
    ReflowOven_parameters_t ReflowParameters;
    ReflowPhases_t currentPhase;
    ReflowPhases_t NextPhase;
} ReflowOven_t;

/******************************************************************************
 * EXTERNAL VARIABLES
 *****************************************************************************/
extern ReflowOven_t ReflowOven; // Reflow oven instance

/*************************
 *  Function Prototypes
 *************************/
/**
 * @brief Initialize reflow oven controller with default parameters
 *
 * Sets up initial temperature profiles, rates, and durations
 * for the various phases of the reflow process.
 */
void ReflowOven_Init(void);

/**
 * @brief Update a specific reflow parameter with a new value
 *
 * @param parameterUpdate Parameter identifier (from ReflowParameters_enum)
 * @param newParameterValue New value to set
 *
 * @note Values are not bounds-checked for safety limits
 */
void ReflowOven_modifyParameters(ReflowParameters_enum parameterUpdate, float newParameterValue);

/**
 * @brief Execute one control cycle for the reflow oven
 *
 * Processes the current state of the reflow oven, updates PID controller
 * and manages state transitions based on temperature and timing conditions.
 *
 * @param PID Pointer to PID controller instance
 * @param currentTemperature Current measured temperature in degrees Celsius
 */
void ReflowOven_operate(PIDController *PID, float currentTemperature);

#endif /* INC_REFLOW_OVEN_PROCESS_H_ */
